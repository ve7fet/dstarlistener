#!/usr/bin/python
import psycopg2
import select
import smtplib
from email.message import EmailMessage
import time
import os # Use environment variables for sensitive info
from dotenv import load_dotenv
_ = load_dotenv()

# Copyright 2025 Lee Woldanski, VE7FET
# Released under GNU GPLv3.0
#
# This script connects to the D-STAR user database, and watches for a notification 
# on the query_changes channel. When it sees a notification of a new user being 
# inserted in the database, it will send an email via Gmail to notify a SysOp.

# Create file called .env in with the KEY = VALUE pairs for sensitive information 
# in the same folder as the script.

# Put both this script, and the .env file in /dstar/scripts

# Put the associated dstar_listener.service file in /usr/lib/systemd/system

# Create a /var/log/dstarlistener folder and chown it to postgres:postgres

# Touch /var/log/dstarlistener/dstarlistener.log and chown it to postgres:postgres

# Run:
#  sudo systemctl daemon-reload
#  sudo systemctl enable dstar_listener.service
#  sudo systemctl start dstar_listener.service
#  sudo systemctl status dstar_listener.service

# Configure logotate to rotate the log file as desired.

# ---------------------------------------------------------------------------------

# Database connection details (use environment variables for security)
# Create a .env file with the KEY = VALUE pairs to be sourced, otherwise 
# the defaults will be used. You SHOULD put the sensitive stuff in the .env file...
DB_NAME = os.environ.get('DB_NAME', 'database')
DB_USER = os.environ.get('DB_USER', 'user')
DB_PASSWORD = os.environ.get('DB_PASSWORD', 'password')
DB_HOST = os.environ.get('DB_HOST', 'localhost')
CHANNEL_NAME = 'query_changes'

# Set DEBUG to 1 to monitor status
DEBUG = 1

# Email details (use environment variables)
SMTP_SERVER = os.environ.get('SMTP_SERVER', 'smtp.gmail.com')
SMTP_PORT = os.environ.get('SMTP_PORT', 465) # or 587 for TLS
EMAIL_USER = os.environ.get('EMAIL_USER', 'sender@gmail.com')
EMAIL_PASS = os.environ.get('EMAIL_PASS', 'app-passwd') # Use an app password if using Gmail
RECIPIENT_EMAIL = os.environ.get('RECIPIENT_EMAIL', 'destemail@somewhere.com')

def send_notification_email(subject, body):
    """Sends an email notification using SMTP."""
    msg = EmailMessage()
    msg.set_content(body)
    msg['Subject'] = subject
    msg['From'] = EMAIL_USER
    msg['To'] = RECIPIENT_EMAIL

    try:
        # Use a secure connection (SSL for 465, or starttls for 587)
        with smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT) as server:
            server.login(EMAIL_USER, EMAIL_PASS)
            server.send_message(msg)
        if DEBUG:
            print(f"Email sent successfully with subject: {subject}")
    except Exception as e:
        print(f"Failed to send email: {e}")

def listen_for_postgres_events():
    """Listens for PostgreSQL notifications and sends emails."""
    try:
        conn = psycopg2.connect(
            dbname=DB_NAME, 
            user=DB_USER, 
            password=DB_PASSWORD, 
            host=DB_HOST
        )
        conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)
        cursor = conn.cursor()
        cursor.execute(f"LISTEN {CHANNEL_NAME};")
        if DEBUG:
            print(f"Waiting for notifications on channel '{CHANNEL_NAME}'...")

        while True:
            # Use select to wait for notifications with a timeout
            if select.select([conn], [], [], 5) == ([], [], []):
                # Timeout occurred, no notification
                if DEBUG:
                    print("Timeout, checking again...")
            else:
                conn.poll()
                while conn.notifies:
                    notify = conn.notifies.pop(0)
                    if DEBUG:
                        print(f"Received notification: Channel={notify.channel}, Payload={notify.payload}, PID={notify.pid}")
                    
                    # Process the payload and send an email
                    email_subject = f"New D-STAR Gateway User Registration"
                    email_body = f"A new D-STAR user has registered with callsign: {notify.payload}"
                    send_notification_email(email_subject, email_body)
            time.sleep(1) # Add a small sleep to prevent busy looping if select is an issue

    except psycopg2.OperationalError as e:
        print(f"Database connection failed: {e}")
    except KeyboardInterrupt:
        print("Listener stopped by user.")
    finally:
        if conn:
            conn.close()

if __name__ == '__main__':
    listen_for_postgres_events()

